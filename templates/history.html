{% extends "base.html" %}

{% block title %}历史记录 - 剧本叙事结构分析系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-clock-history"></i> 分析历史记录</h2>
            <div>
                <button class="btn btn-outline-secondary btn-sm" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
                <button class="btn btn-outline-danger btn-sm" id="cleanupBtn">
                    <i class="bi bi-trash"></i> 清理过期
                </button>
            </div>
        </div>

        <!-- Cache Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-muted">总记录数</h5>
                        <h2 class="mb-0" id="totalEntries">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-muted">缓存命中率</h5>
                        <h2 class="mb-0" id="hitRate">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-muted">缓存命中</h5>
                        <h2 class="mb-0 text-success" id="totalHits">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-muted">缓存未命中</h5>
                        <h2 class="mb-0 text-warning" id="totalMisses">-</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">搜索剧本名称</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="输入剧本名称...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">提供商</label>
                        <select class="form-select" id="providerFilter">
                            <option value="">全部</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="gemini">Gemini</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="openai">OpenAI</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">模型</label>
                        <select class="form-select" id="modelFilter">
                            <option value="">全部</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" id="searchBtn">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>剧本名称</th>
                                <th>提供商/模型</th>
                                <th>场景数</th>
                                <th>TCC数</th>
                                <th>处理时间</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="History pagination" id="paginationNav" style="display: none;">
                    <ul class="pagination justify-content-center mb-0">
                        <li class="page-item" id="prevPage">
                            <a class="page-link" href="#" tabindex="-1">上一页</a>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link" id="pageInfo">第 1 页</span>
                        </li>
                        <li class="page-item" id="nextPage">
                            <a class="page-link" href="#">下一页</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark-text"></i>
                    <span id="modalScriptName">分析详情</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalContent">
                    <div class="text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// State
let currentPage = 0;
const pageSize = 20;
let totalEntries = 0;

// Load cache stats
async function loadStats() {
    try {
        const response = await fetch('/api/cache/stats');
        const stats = await response.json();

        document.getElementById('totalEntries').textContent = stats.total_entries;
        document.getElementById('hitRate').textContent = (stats.hit_rate * 100).toFixed(1) + '%';
        document.getElementById('totalHits').textContent = stats.total_hits;
        document.getElementById('totalMisses').textContent = stats.total_misses;

        // Populate model filter with available models
        const modelSelect = document.getElementById('modelFilter');
        modelSelect.innerHTML = '<option value="">全部</option>';
        for (const [model, count] of Object.entries(stats.entries_by_model || {})) {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = `${model} (${count})`;
            modelSelect.appendChild(option);
        }
    } catch (error) {
        console.error('Failed to load stats:', error);
    }
}

// Load history entries
async function loadHistory() {
    const search = document.getElementById('searchInput').value;
    const provider = document.getElementById('providerFilter').value;
    const model = document.getElementById('modelFilter').value;

    const params = new URLSearchParams({
        limit: pageSize,
        offset: currentPage * pageSize
    });
    if (search) params.append('search', search);
    if (provider) params.append('provider', provider);
    if (model) params.append('model', model);

    try {
        const response = await fetch(`/api/history?${params}`);
        const data = await response.json();

        totalEntries = data.total;
        renderTable(data.entries);
        updatePagination(data);
    } catch (error) {
        console.error('Failed to load history:', error);
        document.getElementById('historyTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-danger">
                    <i class="bi bi-exclamation-triangle"></i> 加载失败: ${error.message}
                </td>
            </tr>
        `;
    }
}

// Render table
function renderTable(entries) {
    const tbody = document.getElementById('historyTableBody');

    if (entries.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <p class="mt-3 mb-0">暂无历史记录</p>
                    <small>上传并分析剧本后，结果将自动缓存到这里</small>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = entries.map(entry => `
        <tr>
            <td><code>${entry.id}</code></td>
            <td>
                <strong>${escapeHtml(entry.script_name)}</strong>
                <br>
                <small class="text-muted">${entry.content_hash.substring(0, 12)}...</small>
            </td>
            <td>
                <span class="badge bg-primary">${entry.provider}</span>
                <br>
                <small>${entry.model || 'default'}</small>
            </td>
            <td>${entry.scene_count || '-'}</td>
            <td>${entry.tcc_count || '-'}</td>
            <td>${entry.processing_time ? entry.processing_time.toFixed(1) + 's' : '-'}</td>
            <td>
                <small>${formatDate(entry.created_at)}</small>
                <br>
                <small class="text-muted">过期: ${formatDate(entry.expires_at)}</small>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewDetail(${entry.id})" title="查看详情">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteEntry(${entry.id})" title="删除">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Update pagination
function updatePagination(data) {
    const nav = document.getElementById('paginationNav');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');

    if (data.total <= pageSize) {
        nav.style.display = 'none';
        return;
    }

    nav.style.display = 'block';
    const totalPages = Math.ceil(data.total / pageSize);
    pageInfo.textContent = `第 ${currentPage + 1} / ${totalPages} 页 (共 ${data.total} 条)`;

    prevBtn.classList.toggle('disabled', currentPage === 0);
    nextBtn.classList.toggle('disabled', !data.has_more);
}

// View detail
async function viewDetail(id) {
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();

    document.getElementById('modalContent').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;

    try {
        const response = await fetch(`/api/history/${id}`);
        const entry = await response.json();

        document.getElementById('modalScriptName').textContent = entry.script_name;
        document.getElementById('modalContent').innerHTML = renderDetailContent(entry);
    } catch (error) {
        document.getElementById('modalContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 加载失败: ${error.message}
            </div>
        `;
    }
}

// Render detail content - Enhanced version with rich visualization
function renderDetailContent(entry) {
    const stage1 = entry.stage1_result || {};
    const stage2 = entry.stage2_result || {};
    const stage3 = entry.stage3_result || {};
    const parsedScript = entry.parsed_script || {};

    let html = '';

    // ===== 概览卡片 =====
    html += `
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card text-center h-100 border-primary">
                    <div class="card-body">
                        <i class="bi bi-film text-primary" style="font-size: 1.5rem;"></i>
                        <h3 class="mb-0 mt-2">${entry.scene_count || 0}</h3>
                        <small class="text-muted">场景数</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100 border-warning">
                    <div class="card-body">
                        <i class="bi bi-diagram-3 text-warning" style="font-size: 1.5rem;"></i>
                        <h3 class="mb-0 mt-2">${entry.tcc_count || 0}</h3>
                        <small class="text-muted">TCC数</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100 border-success">
                    <div class="card-body">
                        <i class="bi bi-clock text-success" style="font-size: 1.5rem;"></i>
                        <h3 class="mb-0 mt-2">${entry.processing_time ? entry.processing_time.toFixed(1) + 's' : '-'}</h3>
                        <small class="text-muted">处理时间</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100 border-info">
                    <div class="card-body">
                        <i class="bi bi-cloud text-info" style="font-size: 1.5rem;"></i>
                        <h3 class="mb-0 mt-2">${entry.api_calls || 0}</h3>
                        <small class="text-muted">API调用</small>
                    </div>
                </div>
            </div>
        </div>
    `;

    // ===== 基本信息 =====
    // 截取哈希值前16位用于显示
    const shortHash = entry.content_hash ? entry.content_hash.substring(0, 16) + '...' : '-';

    html += `
        <div class="card mb-4">
            <div class="card-header bg-light">
                <i class="bi bi-info-circle"></i> 基本信息
            </div>
            <div class="card-body py-3">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <span class="text-muted me-3" style="min-width: 80px;">记录 ID</span>
                            <code class="bg-light px-2 py-1 rounded">${entry.id}</code>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="text-muted me-3" style="min-width: 80px;">内容哈希</span>
                            <code class="bg-light px-2 py-1 rounded small" title="${entry.content_hash}">${shortHash}</code>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="text-muted me-3" style="min-width: 80px;">提供商</span>
                            <span class="badge bg-primary">${entry.provider || '-'}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="text-muted me-3" style="min-width: 80px;">模型</span>
                            <span class="badge bg-secondary">${entry.model || 'default'}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <span class="text-muted me-3" style="min-width: 80px;">创建时间</span>
                            <span>${formatDate(entry.created_at)}</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="text-muted me-3" style="min-width: 80px;">过期时间</span>
                            <span>${formatDate(entry.expires_at)}</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="text-muted me-3" style="min-width: 80px;">缓存状态</span>
                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> 有效</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="text-muted me-3" style="min-width: 80px;">脚本名称</span>
                            <span class="text-truncate" style="max-width: 200px;" title="${escapeHtml(entry.script_name)}">${escapeHtml(entry.script_name || '-')}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // ===== Tab 导航 =====
    html += `
        <ul class="nav nav-tabs mb-3" id="detailTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tcc-tab" data-bs-toggle="tab" data-bs-target="#tccContent" type="button">
                    <i class="bi bi-diagram-3"></i> TCC 识别
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ranking-tab" data-bs-toggle="tab" data-bs-target="#rankingContent" type="button">
                    <i class="bi bi-bar-chart"></i> A/B/C 分级
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="scenes-tab" data-bs-toggle="tab" data-bs-target="#scenesContent" type="button">
                    <i class="bi bi-collection-play"></i> 场景列表
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="modifications-tab" data-bs-toggle="tab" data-bs-target="#modificationsContent" type="button">
                    <i class="bi bi-wrench"></i> 修改记录
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="raw-tab" data-bs-toggle="tab" data-bs-target="#rawContent" type="button">
                    <i class="bi bi-code-slash"></i> 原始数据
                </button>
            </li>
        </ul>

        <div class="tab-content" id="detailTabContent">
    `;

    // ===== Tab 1: TCC 识别 =====
    html += `<div class="tab-pane fade show active" id="tccContent" role="tabpanel">`;
    html += renderTCCsContent(stage1);
    html += `</div>`;

    // ===== Tab 2: A/B/C 分级 =====
    html += `<div class="tab-pane fade" id="rankingContent" role="tabpanel">`;
    html += renderRankingsContent(stage2);
    html += `</div>`;

    // ===== Tab 3: 场景列表 =====
    html += `<div class="tab-pane fade" id="scenesContent" role="tabpanel">`;
    html += renderScenesContent(parsedScript);
    html += `</div>`;

    // ===== Tab 4: 修改记录 =====
    html += `<div class="tab-pane fade" id="modificationsContent" role="tabpanel">`;
    html += renderModificationsContent(stage3);
    html += `</div>`;

    // ===== Tab 5: 原始数据 =====
    html += `
        <div class="tab-pane fade" id="rawContent" role="tabpanel">
            <div class="accordion" id="rawDataAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#stage1Raw">
                            Stage 1: Discoverer Output
                        </button>
                    </h2>
                    <div id="stage1Raw" class="accordion-collapse collapse" data-bs-parent="#rawDataAccordion">
                        <div class="accordion-body">
                            <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto; font-size: 12px;"><code>${JSON.stringify(stage1, null, 2)}</code></pre>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#stage2Raw">
                            Stage 2: Auditor Output
                        </button>
                    </h2>
                    <div id="stage2Raw" class="accordion-collapse collapse" data-bs-parent="#rawDataAccordion">
                        <div class="accordion-body">
                            <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto; font-size: 12px;"><code>${JSON.stringify(stage2, null, 2)}</code></pre>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#stage3Raw">
                            Stage 3: Modifier Output
                        </button>
                    </h2>
                    <div id="stage3Raw" class="accordion-collapse collapse" data-bs-parent="#rawDataAccordion">
                        <div class="accordion-body">
                            <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto; font-size: 12px;"><code>${JSON.stringify(stage3, null, 2)}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    html += `</div>`; // End tab-content

    return html;
}

// Render TCCs content
function renderTCCsContent(stage1) {
    const tccs = stage1.tccs || [];

    if (tccs.length === 0) {
        return `
            <div class="text-center py-5 text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">未识别到戏剧冲突链 (TCC)</p>
            </div>
        `;
    }

    // Calculate average confidence
    const avgConfidence = tccs.reduce((sum, tcc) => sum + (tcc.confidence || 0), 0) / tccs.length;

    let html = `
        <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i>
            共识别出 <strong>${tccs.length}</strong> 个戏剧冲突链，平均置信度 <strong>${(avgConfidence * 100).toFixed(1)}%</strong>
        </div>
    `;

    tccs.forEach((tcc, index) => {
        const confidenceClass = tcc.confidence >= 0.9 ? 'success' : tcc.confidence >= 0.7 ? 'warning' : 'danger';
        const borderClass = index === 0 ? 'border-warning' : index === 1 ? 'border-info' : 'border-secondary';

        html += `
            <div class="card mb-3 border-start border-4 ${borderClass}">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <span>
                        <strong>${tcc.tcc_id}</strong>
                        <span class="badge bg-${confidenceClass} ms-2">${((tcc.confidence || 0) * 100).toFixed(0)}% 置信度</span>
                    </span>
                    <span class="badge bg-light text-dark">${tcc.core_conflict_type || '未知类型'}</span>
                </div>
                <div class="card-body">
                    <h6 class="text-muted mb-2">超级目标 (Super Objective)</h6>
                    <p class="lead mb-3">${escapeHtml(tcc.super_objective || '未指定')}</p>

                    ${tcc.evidence_scenes && tcc.evidence_scenes.length > 0 ? `
                        <h6 class="text-muted mb-2">证据场景</h6>
                        <div class="mb-0">
                            ${tcc.evidence_scenes.map(s => `<span class="badge bg-secondary me-1">${s}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });

    // Metadata
    if (stage1.metadata) {
        html += `
            <div class="card bg-light">
                <div class="card-body small">
                    <strong>元数据:</strong>
                    分析场景数: ${stage1.metadata.total_scenes_analyzed || '-'} |
                    主要证据可用: ${stage1.metadata.primary_evidence_available ? '是' : '否'} |
                    回退模式: ${stage1.metadata.fallback_mode ? '是' : '否'}
                    ${stage1.metadata.fallback_reason ? `<br><span class="text-muted">回退原因: ${stage1.metadata.fallback_reason}</span>` : ''}
                </div>
            </div>
        `;
    }

    return html;
}

// Render Rankings content
function renderRankingsContent(stage2) {
    const rankings = stage2.rankings || {};

    if (!rankings.a_line && (!rankings.b_lines || rankings.b_lines.length === 0) && (!rankings.c_lines || rankings.c_lines.length === 0)) {
        return `
            <div class="text-center py-5 text-muted">
                <i class="bi bi-bar-chart" style="font-size: 3rem;"></i>
                <p class="mt-3">无分级数据</p>
            </div>
        `;
    }

    let html = '';

    // A-Line (Spine)
    html += `<div class="card mb-3 border-start border-4 border-warning">`;
    html += `<div class="card-header bg-warning bg-opacity-10"><strong><i class="bi bi-star-fill text-warning"></i> A 线 (主线 / Spine)</strong></div>`;
    html += `<div class="card-body">`;
    if (rankings.a_line) {
        const aLine = rankings.a_line;
        html += `
            <h5>${aLine.tcc_id}</h5>
            <p class="mb-2">${escapeHtml(aLine.super_objective || '未指定')}</p>
            <div class="row">
                <div class="col-md-4">
                    <div class="bg-light rounded p-2 text-center">
                        <small class="text-muted d-block">Spine 评分</small>
                        <strong class="text-warning">${aLine.spine_score?.toFixed(1) || '-'} / 10</strong>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="bg-light rounded p-2 text-center">
                        <small class="text-muted d-block">场景数</small>
                        <strong>${aLine.reasoning?.scene_count || '-'}</strong>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="bg-light rounded p-2 text-center">
                        <small class="text-muted d-block">驱动高潮</small>
                        <strong>${aLine.reasoning?.drives_climax ? '是' : '否'}</strong>
                    </div>
                </div>
            </div>
            ${aLine.forces ? `
                <div class="mt-3">
                    <small class="text-muted">力量分析:</small>
                    <ul class="small mb-0">
                        ${aLine.forces.protagonist ? `<li><strong>主角:</strong> ${escapeHtml(aLine.forces.protagonist)}</li>` : ''}
                        ${aLine.forces.primary_antagonist ? `<li><strong>主要对手:</strong> ${escapeHtml(aLine.forces.primary_antagonist)}</li>` : ''}
                    </ul>
                </div>
            ` : ''}
        `;
    } else {
        html += `<p class="text-muted mb-0">未识别到 A 线</p>`;
    }
    html += `</div></div>`;

    // B-Lines (Heart)
    html += `<div class="card mb-3 border-start border-4 border-info">`;
    html += `<div class="card-header bg-info bg-opacity-10"><strong><i class="bi bi-heart-fill text-info"></i> B 线 (副线 / Heart)</strong></div>`;
    html += `<div class="card-body">`;
    if (rankings.b_lines && rankings.b_lines.length > 0) {
        rankings.b_lines.forEach(bLine => {
            html += `
                <div class="border-bottom pb-2 mb-2">
                    <h6>${bLine.tcc_id}</h6>
                    <p class="mb-1 small">${escapeHtml(bLine.super_objective || '未指定')}</p>
                    <span class="badge bg-info">Heart 评分: ${bLine.heart_score?.toFixed(1) || '-'}</span>
                </div>
            `;
        });
    } else {
        html += `<p class="text-muted mb-0">未识别到 B 线</p>`;
    }
    html += `</div></div>`;

    // C-Lines (Flavor)
    html += `<div class="card mb-3 border-start border-4 border-secondary">`;
    html += `<div class="card-header bg-secondary bg-opacity-10"><strong><i class="bi bi-palette text-secondary"></i> C 线 (次线 / Flavor)</strong></div>`;
    html += `<div class="card-body">`;
    if (rankings.c_lines && rankings.c_lines.length > 0) {
        rankings.c_lines.forEach(cLine => {
            html += `
                <div class="border-bottom pb-2 mb-2">
                    <h6>${cLine.tcc_id}</h6>
                    <p class="mb-1 small">${escapeHtml(cLine.super_objective || '未指定')}</p>
                    <span class="badge bg-secondary">Flavor 评分: ${cLine.flavor_score?.toFixed(1) || '-'}</span>
                </div>
            `;
        });
    } else {
        html += `<p class="text-muted mb-0">未识别到 C 线</p>`;
    }
    html += `</div></div>`;

    // Metrics
    if (stage2.metrics) {
        html += `
            <div class="card bg-light">
                <div class="card-body small">
                    <strong>覆盖率:</strong>
                    A 线: ${((stage2.metrics.a_line_coverage || 0) * 100).toFixed(0)}% |
                    B 线: ${((stage2.metrics.b_line_coverage || 0) * 100).toFixed(0)}% |
                    C 线: ${((stage2.metrics.c_line_coverage || 0) * 100).toFixed(0)}%
                </div>
            </div>
        `;
    }

    return html;
}

// Render Scenes content
function renderScenesContent(parsedScript) {
    const scenes = parsedScript.scenes || [];

    if (scenes.length === 0) {
        return `
            <div class="text-center py-5 text-muted">
                <i class="bi bi-collection-play" style="font-size: 3rem;"></i>
                <p class="mt-3">无场景数据</p>
            </div>
        `;
    }

    let html = `
        <div class="alert alert-secondary mb-3">
            <i class="bi bi-film"></i> 共 <strong>${scenes.length}</strong> 个场景
        </div>
        <div class="accordion" id="scenesAccordion">
    `;

    scenes.forEach((scene, index) => {
        const characters = scene.characters || [];
        const keyEvents = scene.key_events || [];

        html += `
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#scene${index}">
                        <span class="badge bg-dark me-2">${scene.scene_id}</span>
                        ${escapeHtml(scene.setting || '未知场景')}
                        <span class="badge bg-light text-dark ms-auto">${characters.length} 角色</span>
                    </button>
                </h2>
                <div id="scene${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#scenesAccordion">
                    <div class="accordion-body">
                        ${scene.scene_mission ? `
                            <div class="mb-3">
                                <strong class="text-primary">场景使命:</strong>
                                <p class="mb-0">${escapeHtml(scene.scene_mission)}</p>
                            </div>
                        ` : ''}

                        ${characters.length > 0 ? `
                            <div class="mb-3">
                                <strong>角色:</strong>
                                ${characters.slice(0, 10).map(c => `<span class="badge bg-outline-secondary border me-1">${escapeHtml(c)}</span>`).join('')}
                                ${characters.length > 10 ? `<span class="text-muted">...等 ${characters.length} 人</span>` : ''}
                            </div>
                        ` : ''}

                        ${keyEvents.length > 0 ? `
                            <div class="mb-0">
                                <strong>关键事件:</strong>
                                <ul class="small mb-0">
                                    ${keyEvents.slice(0, 5).map(e => `<li>${escapeHtml(e)}</li>`).join('')}
                                    ${keyEvents.length > 5 ? `<li class="text-muted">...等 ${keyEvents.length} 个事件</li>` : ''}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });

    html += `</div>`;
    return html;
}

// Render Modifications content
function renderModificationsContent(stage3) {
    const modificationLog = stage3.modification_log || [];
    const validation = stage3.validation || {};

    let html = '';

    // Validation summary
    html += `
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card text-center ${validation.total_issues > 0 ? 'border-warning' : 'border-success'}">
                    <div class="card-body py-2">
                        <h4 class="mb-0">${validation.total_issues || 0}</h4>
                        <small class="text-muted">发现问题</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body py-2">
                        <h4 class="mb-0 text-success">${validation.fixed || 0}</h4>
                        <small class="text-muted">已修复</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-secondary">
                    <div class="card-body py-2">
                        <h4 class="mb-0">${validation.skipped || 0}</h4>
                        <small class="text-muted">已跳过</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center ${validation.new_issues_introduced > 0 ? 'border-danger' : 'border-light'}">
                    <div class="card-body py-2">
                        <h4 class="mb-0 ${validation.new_issues_introduced > 0 ? 'text-danger' : ''}">${validation.new_issues_introduced || 0}</h4>
                        <small class="text-muted">新增问题</small>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Modification log
    if (modificationLog.length === 0) {
        html += `
            <div class="text-center py-4 text-muted">
                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                <p class="mt-3 mb-0">无需修改，剧本结构完整</p>
            </div>
        `;
    } else {
        html += `<div class="list-group">`;
        modificationLog.forEach((mod, index) => {
            const statusClass = mod.status === 'applied' ? 'success' : mod.status === 'skipped' ? 'secondary' : 'warning';
            const statusIcon = mod.status === 'applied' ? 'check-circle' : mod.status === 'skipped' ? 'skip-forward' : 'exclamation-circle';

            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge bg-${statusClass} me-2"><i class="bi bi-${statusIcon}"></i> ${mod.status || '未知'}</span>
                            <strong>${mod.issue_id || '修改 ' + (index + 1)}</strong>
                        </div>
                        <small class="text-muted">${mod.change_type || '-'}</small>
                    </div>
                    ${mod.field ? `<p class="mb-1 mt-2 small"><strong>字段:</strong> ${mod.field}</p>` : ''}
                    ${mod.old_value ? `<p class="mb-1 small text-danger"><strong>旧值:</strong> ${escapeHtml(String(mod.old_value).substring(0, 100))}</p>` : ''}
                    ${mod.new_value ? `<p class="mb-0 small text-success"><strong>新值:</strong> ${escapeHtml(String(mod.new_value).substring(0, 100))}</p>` : ''}
                </div>
            `;
        });
        html += `</div>`;
    }

    return html;
}

// Delete entry
async function deleteEntry(id) {
    if (!confirm(`确定要删除记录 #${id} 吗？此操作不可恢复。`)) {
        return;
    }

    try {
        const response = await fetch(`/api/history/${id}`, { method: 'DELETE' });
        if (response.ok) {
            loadStats();
            loadHistory();
        } else {
            const error = await response.json();
            alert('删除失败: ' + (error.detail || '未知错误'));
        }
    } catch (error) {
        alert('删除失败: ' + error.message);
    }
}

// Cleanup expired
async function cleanupExpired() {
    if (!confirm('确定要清理所有过期的缓存记录吗？')) {
        return;
    }

    try {
        const response = await fetch('/api/cache/cleanup', { method: 'POST' });
        const result = await response.json();
        alert(`清理完成，共删除 ${result.removed_count} 条过期记录`);
        loadStats();
        loadHistory();
    } catch (error) {
        alert('清理失败: ' + error.message);
    }
}

// Helper functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Event listeners
document.getElementById('refreshBtn').addEventListener('click', () => {
    loadStats();
    loadHistory();
});

document.getElementById('cleanupBtn').addEventListener('click', cleanupExpired);

document.getElementById('searchBtn').addEventListener('click', () => {
    currentPage = 0;
    loadHistory();
});

document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        currentPage = 0;
        loadHistory();
    }
});

document.getElementById('prevPage').addEventListener('click', (e) => {
    e.preventDefault();
    if (currentPage > 0) {
        currentPage--;
        loadHistory();
    }
});

document.getElementById('nextPage').addEventListener('click', (e) => {
    e.preventDefault();
    if ((currentPage + 1) * pageSize < totalEntries) {
        currentPage++;
        loadHistory();
    }
});

// Initial load
loadStats();
loadHistory();
</script>
{% endblock %}
